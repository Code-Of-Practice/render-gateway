{"version":3,"sources":["../../src/shared/shutdown.js"],"names":["startedGateway","gatewayStarted","gateway","Error","shutdownGateway","logger","Promise","resolve","reject","debug","close","err","simplifiedError","error","includes","info","then","process","exit","catch"],"mappings":";;;;;;;AACA;;AAGA,IAAIA,cAA4B,GAAG,IAAnC;AAEA;;;;;;;AAMO,MAAMC,cAA8C,GAAIC,OAAD,IAAa;AACvE,MAAIF,cAAc,IAAI,IAAtB,EAA4B;AACxB,UAAM,IAAIG,KAAJ,CAAU,0BAAV,CAAN;AACH;;AACDH,EAAAA,cAAc,GAAGE,OAAjB;AACH,CALM;AAOP;;;;;;;;;;;AAOO,MAAME,eAAkD,GAAIC,MAAD,IAC9D,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC7B,MAAIR,cAAc,IAAI,IAAtB,EAA4B;AACxBO,IAAAA,OAAO;AACP;AACH;;AACDF,EAAAA,MAAM,CAACI,KAAP,CAAa,kBAAb;AACAT,EAAAA,cAAc,CAACU,KAAf,CAAsBC,GAAD,IAAS;AAC1B,QAAIA,GAAJ,EAAS;AACL,YAAMC,eAAe,GAAG,gCAAaD,GAAb,CAAxB;;AAEA,UACIC,eAAe,CAACC,KAAhB,IACAD,eAAe,CAACC,KAAhB,CAAsBC,QAAtB,CAA+B,wBAA/B,CAFJ,EAGE;AACET,QAAAA,MAAM,CAACU,IAAP,CAAY,yBAAZ,EAAuC,MAAMR,OAAO,EAApD;AACH,OALD,MAKO;AACHF,QAAAA,MAAM,CAACQ,KAAP,CAAa,uBAAb,EAAsCD,eAAtC,EAAuD,MACnDJ,MAAM,EADV;AAGH;AACJ,KAbD,MAaO;AACHH,MAAAA,MAAM,CAACU,IAAP,CAAY,wCAAZ,EAAsD,MAClDR,OAAO,EADX;AAGH;AACJ,GAnBD;AAoBH,CA1BD,EA2BKS,IA3BL,CA2BU,MAAMC,OAAO,CAACC,IAAR,CAAa,CAAb,CA3BhB,EA4BKC,KA5BL,CA4BW,MAAMF,OAAO,CAACC,IAAR,CAAa,CAAb,CA5BjB,CADG","sourcesContent":["// @flow\nimport {extractError} from \"./extract-error.js\";\nimport type {Logger} from \"./types.js\";\n\nlet startedGateway: ?http$Server = null;\n\n/**\n * Register the started gateway.\n *\n * This sets the started gateway so that it can be shutdown when\n * `shutdownGateway` is invoked.\n */\nexport const gatewayStarted: (gateway: http$Server) => void = (gateway) => {\n    if (startedGateway != null) {\n        throw new Error(\"Gateway already started.\");\n    }\n    startedGateway = gateway;\n};\n\n/**\n * Shutdown the running gateway process.\n *\n * This closes any started express server and exits the process.\n * This must be written such that errors don't need to be handled by calling\n * code.\n */\nexport const shutdownGateway: (logger: Logger) => Promise<void> = (logger) =>\n    new Promise((resolve, reject) => {\n        if (startedGateway == null) {\n            resolve();\n            return;\n        }\n        logger.debug(\"Closing gateway.\");\n        startedGateway.close((err) => {\n            if (err) {\n                const simplifiedError = extractError(err);\n\n                if (\n                    simplifiedError.error &&\n                    simplifiedError.error.includes(\"ERR_SERVER_NOT_RUNNING\")\n                ) {\n                    logger.info(\"Gateway already closed.\", () => resolve());\n                } else {\n                    logger.error(\"Error closing gateway\", simplifiedError, () =>\n                        reject(),\n                    );\n                }\n            } else {\n                logger.info(\"Gateway closed. Shutting down process.\", () =>\n                    resolve(),\n                );\n            }\n        });\n    })\n        .then(() => process.exit(0))\n        .catch(() => process.exit(1));\n"],"file":"shutdown.js"}