{"version":3,"sources":["../../src/shared/shutdown.js"],"names":["startedGateway","gatewayStarted","gateway","Error","shutdownGateway","logger","Promise","resolve","reject","debug","process","send","close","err","simplifiedError","error","includes","info","setTimeout","then","exit","catch"],"mappings":";;;;;;;AACA;;AAGA,IAAIA,cAA4B,GAAG,IAAnC;AAEA;;;;;;;AAMO,MAAMC,cAA8C,GAAIC,OAAD,IAAa;AACvE,MAAIF,cAAc,IAAI,IAAtB,EAA4B;AACxB,UAAM,IAAIG,KAAJ,CAAU,0BAAV,CAAN;AACH;;AACDH,EAAAA,cAAc,GAAGE,OAAjB;AACH,CALM;AAOP;;;;;;;;;;;AAOO,MAAME,eAAkD,GAAIC,MAAD,IAC9D,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC7B,MAAIR,cAAc,IAAI,IAAtB,EAA4B;AACxBO,IAAAA,OAAO;AACP;AACH;;AACDF,EAAAA,MAAM,CAACI,KAAP,CAAa,kBAAb,EAL6B,CAO7B;AACA;;AACA,MAAIC,OAAO,CAACC,IAAZ,EAAkB;AACdD,IAAAA,OAAO,CAACC,IAAR,CAAa,SAAb;AACH;;AAEDX,EAAAA,cAAc,CAACY,KAAf,CAAsBC,GAAD,IAAS;AAC1B,QAAIA,GAAJ,EAAS;AACL,YAAMC,eAAe,GAAG,gCAAaD,GAAb,CAAxB;;AAEA,UACIC,eAAe,CAACC,KAAhB,IACAD,eAAe,CAACC,KAAhB,CAAsBC,QAAtB,CAA+B,wBAA/B,CAFJ,EAGE;AACEX,QAAAA,MAAM,CAACY,IAAP,CAAY,yBAAZ,EAAuC,MAAMV,OAAO,EAApD;AACH,OALD,MAKO;AACHF,QAAAA,MAAM,CAACU,KAAP,CAAa,uBAAb,EAAsCD,eAAtC,EAAuD,MACnDN,MAAM,EADV;AAGH;AACJ,KAbD,MAaO;AACHH,MAAAA,MAAM,CAACY,IAAP,CAAY,wCAAZ,EAAsD,MAClDV,OAAO,EADX;AAGH;AACJ,GAnBD,EAb6B,CAkC7B;AACA;;AACAW,EAAAA,UAAU,CAAC,MAAM;AACbb,IAAAA,MAAM,CAACU,KAAP,CACI,iDADJ,EAEI,MAAMP,MAAM,EAFhB;AAIH,GALS,EAKP,KALO,CAAV;AAMH,CA1CD,EA2CKW,IA3CL,CA2CU,MAAMT,OAAO,CAACU,IAAR,CAAa,CAAb,CA3ChB,EA4CKC,KA5CL,CA4CW,MAAMX,OAAO,CAACU,IAAR,CAAa,CAAb,CA5CjB,CADG","sourcesContent":["// @flow\nimport {extractError} from \"./extract-error.js\";\nimport type {Logger} from \"./types.js\";\n\nlet startedGateway: ?http$Server = null;\n\n/**\n * Register the started gateway.\n *\n * This sets the started gateway so that it can be shutdown when\n * `shutdownGateway` is invoked.\n */\nexport const gatewayStarted: (gateway: http$Server) => void = (gateway) => {\n    if (startedGateway != null) {\n        throw new Error(\"Gateway already started.\");\n    }\n    startedGateway = gateway;\n};\n\n/**\n * Shutdown the running gateway process.\n *\n * This closes any started express server and exits the process.\n * This must be written such that errors don't need to be handled by calling\n * code.\n */\nexport const shutdownGateway: (logger: Logger) => Promise<void> = (logger) =>\n    new Promise((resolve, reject) => {\n        if (startedGateway == null) {\n            resolve();\n            return;\n        }\n        logger.debug(\"Closing gateway.\");\n\n        // We notify the process manager that we're about to go offline\n        // so that it stops sending us new requests.\n        if (process.send) {\n            process.send(\"offline\");\n        }\n\n        startedGateway.close((err) => {\n            if (err) {\n                const simplifiedError = extractError(err);\n\n                if (\n                    simplifiedError.error &&\n                    simplifiedError.error.includes(\"ERR_SERVER_NOT_RUNNING\")\n                ) {\n                    logger.info(\"Gateway already closed.\", () => resolve());\n                } else {\n                    logger.error(\"Error closing gateway\", simplifiedError, () =>\n                        reject(),\n                    );\n                }\n            } else {\n                logger.info(\"Gateway closed. Shutting down process.\", () =>\n                    resolve(),\n                );\n            }\n        });\n\n        // If the server hasn't shutdown in 15s then we force it to shutdown\n        // This could be because of connections being kept alive\n        setTimeout(() => {\n            logger.error(\n                \"Server failed to close. Forcing it to shutdown.\",\n                () => reject(),\n            );\n        }, 15000);\n    })\n        .then(() => process.exit(0))\n        .catch(() => process.exit(1));\n"],"file":"shutdown.js"}